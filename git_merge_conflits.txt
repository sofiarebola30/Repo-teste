a lot of changes to the code